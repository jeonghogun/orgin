# 보안 평가: 암호화된 데이터 검색 방안 분석

## 1. 문제 정의: `content_searchable` 평문 저장 리스크

현재 `messages` 테이블은 `pgcrypto`를 사용하여 `content` 컬럼을 암호화하고 있습니다. 하지만 전문 검색(Full-text Search) 기능을 지원하기 위해, 암호화되지 않은 평문 내용이 `content_searchable` 컬럼에 별도로 저장되고 있습니다.

- **리스크:** 데이터베이스가 침해될 경우(예: SQL 인젝션, DB 엑세스 키 유출), `content_searchable` 컬럼을 통해 모든 메시지의 원본 내용을 조회할 수 있습니다. 이는 "저장 시 암호화(Encryption-at-rest)"의 보안 목표를 부분적으로 약화시킵니다.
- **현실적 트레이드오프:** 이 방식은 PostgreSQL의 강력한 전문 검색 인덱싱(GIN/GIST)을 직접 활용할 수 있어, 구현이 간단하고 검색 성능이 매우 빠르다는 장점이 있습니다.

이 문서는 이 리스크를 완화하거나 제거하기 위한 기술적인 대체 방안을 조사하고, 현실성을 비교 분석합니다.

## 2. 대체 방안 조사

### 방안 1: 검색 가능한 대칭 암호 (Searchable Symmetric Encryption, SSE)

- **개념:** 데이터를 암호화하면서, 동시에 해당 데이터에 대한 검색이 가능한 암호화된 인덱스를 생성하는 암호학적 기법입니다. 서버는 암호화된 인덱스만으로 사용자의 검색 쿼리(암호화된 토큰)를 처리할 수 있으며, 실제 문서 내용은 복호화하지 않습니다.
- **장점:**
    - **강력한 보안:** 서버(DB)는 문서의 원본 내용이나 검색 키워드의 원본을 알 수 없습니다.
    - **정보 유출 최소화:** 검색 결과로 어떤 문서가 매칭되었는지(Access Pattern) 외에는 정보 유출이 거의 없습니다.
- **단점:**
    - **구현 복잡성:** 직접 구현하기 매우 어렵고, 전문 라이브러리(e.g., `PySSE`)를 사용해야 합니다. 애플리케이션 로직이 크게 복잡해집니다.
    - **성능 오버헤드:** 암호화된 인덱스를 생성하고 검색하는 과정은 평문 검색보다 훨씬 느립니다.
    - **쿼리 제약:** 부분 문자열 검색, 유사도 검색(fuzzy search), 순위 지정(ranking) 등 복잡한 쿼리를 지원하기 어렵습니다. 주로 정확한 키워드 매칭에 사용됩니다.

### 방안 2: 토큰화 및 해싱 (Tokenization and Hashing)

- **개념:** 문서를 단어(토큰) 단위로 분리하고, 각 토큰을 솔트(Salt)와 함께 해시(e.g., HMAC-SHA256)하여 별도의 인덱스 테이블에 저장합니다. 검색 시에도 사용자의 검색어를 동일한 방식으로 해시하여 인덱스 테이블을 조회합니다.
- **장점:**
    - **적당한 보안:** 원본 키워드를 직접 저장하지 않으므로 평문 저장보다 안전합니다.
    - **구현 용이성:** SSE보다 상대적으로 구현이 간단합니다.
- **단점:**
    - **정확한 매칭만 가능:** `LIKE '%검색어%'`와 같은 부분 검색이나 오타를 보정하는 유사도 검색이 불가능합니다. "origin"을 검색하면 "original"은 찾을 수 없습니다.
    - **레인보우 테이블 공격 가능성:** 솔트를 사용하더라도, 자주 사용되는 단어에 대해서는 해시값을 미리 계산해두는 공격에 취약할 수 있습니다.

### 방안 3: 동형 암호 (Homomorphic Encryption)

- **개념:** 암호화된 상태에서 데이터의 연산(덧셈, 곱셈 등)이 가능한 "꿈의 암호 기술"입니다. 이론적으로 암호화된 데이터에 대해 직접 검색 연산을 수행할 수 있습니다.
- **장점:**
    - **최고 수준의 보안:** 데이터 처리 전 과정에서 원본 데이터가 전혀 노출되지 않습니다.
- **단점:**
    - **현재 기술적 한계:** **매우 느립니다.** 현재 연구 단계에 가까우며, 일반적인 웹 애플리케이션의 검색 엔진으로 사용하기에는 성능이 수백~수천 배 이상 느려 현실적으로 적용이 불가능합니다.

## 3. 비교 및 최종 권장안

| 평가 항목 | 현재 방식 (평문) | 토큰화+해싱 | SSE | 동형 암호 |
| :--- | :--- | :--- | :--- | :--- |
| **보안 수준** | 낮음 | 중간 | 높음 | 매우 높음 |
| **구현 복잡도** | 매우 낮음 | 낮음 | 매우 높음 | (현실적으로) 불가능 |
| **성능 오버헤드** | 없음 | 낮음 | 높음 | 매우 높음 |
| **쿼리 유연성** | 매우 높음 (전문 검색) | 낮음 (정확한 단어) | 낮음~중간 | 이론적으로 높음 |
| **현실성** | **높음** | **높음** | **낮음** | **매우 낮음** |

---

### 최종 권장안

- **단기 (현실적 방안):**
  **현재의 `content_searchable` 평문 컬럼 방식을 유지**하는 것이 가장 현실적인 선택입니다. 이는 기능적 요구사항(빠르고 유연한 전문 검색)과 구현 용이성을 만족시키는, 잘 알려진 트레이드오프입니다. 대신, 이 리스크를 명확히 인지하고 데이터베이스 접근 제어, 감사 로그, 네트워크 보안 등 다른 계층의 보안을 강화하여 DB 침해 자체를 방지하는 데 집중해야 합니다.

- **장기 (이상적 방안):**
  만약 프로젝트가 고도의 기밀성을 요구하는 수준(예: 의료, 법률 데이터 처리)으로 발전한다면, **SSE(검색 가능한 대칭 암호) 도입을 검토**해야 합니다. 이는 상당한 연구 개발 리소스 투입을 필요로 하며, 검색 기능의 일부 제약(예: 유사도 검색 포기)을 감수해야 하는 전략적 결정이 될 것입니다.

결론적으로, 현재 단계에서는 평문 컬럼의 리스크를 인지하고 관리하는 것이 가장 합리적이며, 더 높은 수준의 보안이 요구될 때 SSE로의 전환을 로드맵에 포함시키는 것을 권장합니다.
